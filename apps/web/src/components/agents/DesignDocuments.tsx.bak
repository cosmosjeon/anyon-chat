"use client";

import { useQuery } from "@tanstack/react-query";
import { Card, CardContent, CardDescription, CardHeader, CardTitle } from "@/components/ui/card";
import { Button } from "@/components/ui/button";
import { Tabs, TabsContent, TabsList, TabsTrigger } from "@/components/ui/tabs";
import { Download, FileText, Loader2 } from "lucide-react";
import ReactMarkdown from "react-markdown";

interface DesignDocumentsProps {
  jobId: string;
}

interface DesignDocument {
  fileName: string;
  content: string;
  version: string;
  createdAt: string;
}

interface DesignDocumentsData {
  jobId: string;
  status: string;
  documents: Record<string, DesignDocument>;
  documentCount: number;
}

const DOCUMENT_TYPES = [
  {
    key: "design_system",
    label: "Design System",
    description: "Component library, colors, and typography",
    icon: "üé®",
  },
  {
    key: "ux_flow",
    label: "UX Flow",
    description: "User experience flows and interactions",
    icon: "üîÑ",
  },
  {
    key: "screen_specs",
    label: "Screen Specifications",
    description: "Detailed specifications for each screen",
    icon: "üì±",
  },
  {
    key: "ai_prompts",
    label: "AI Studio Prompts",
    description: "Prompts for visual design generation",
    icon: "‚ú®",
  },
  {
    key: "design_guidelines",
    label: "Design Guidelines",
    description: "Design principles and rules",
    icon: "üìê",
  },
  {
    key: "open_source_recs",
    label: "Library Recommendations",
    description: "Recommended open-source libraries",
    icon: "üì¶",
  },
];

export function DesignDocuments({ jobId }: DesignDocumentsProps) {
  const { data, isLoading, error } = useQuery<DesignDocumentsData>({
    queryKey: ["designDocuments", jobId],
    queryFn: async () => {
      const response = await fetch(`/api/design/documents/${jobId}`);
      if (!response.ok) throw new Error("Failed to fetch documents");
      return response.json();
    },
  });

  const downloadDocument = (doc: DesignDocument) => {
    const blob = new Blob([doc.content], { type: "text/markdown" });
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = doc.fileName;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
  };

  const downloadAllDocuments = () => {
    if (!data) return;
    Object.values(data.documents).forEach((doc) => {
      setTimeout(() => downloadDocument(doc), 100);
    });
  };

  if (isLoading) {
    return (
      <Card>
        <CardContent className="flex items-center justify-center p-8">
          <Loader2 className="h-8 w-8 animate-spin" />
        </CardContent>
      </Card>
    );
  }

  if (error) {
    return (
      <Card>
        <CardContent className="p-8">
          <p className="text-red-500">Failed to load documents</p>
        </CardContent>
      </Card>
    );
  }

  if (!data || data.documentCount === 0) {
    return (
      <Card>
        <CardContent className="p-8 text-center text-muted-foreground">
          <FileText className="h-12 w-12 mx-auto mb-2 opacity-50" />
          <p>No documents available yet</p>
          <p className="text-sm">Documents will appear here once the design phase is complete</p>
        </CardContent>
      </Card>
    );
  }

  return (
    <Card>
      <CardHeader>
        <div className="flex items-center justify-between">
          <div>
            <CardTitle>Design Documents</CardTitle>
            <CardDescription>
              {data.documentCount} document{data.documentCount !== 1 ? "s" : ""} generated
            </CardDescription>
          </div>
          <Button onClick={downloadAllDocuments} variant="outline" size="sm">
            <Download className="h-4 w-4 mr-2" />
            Download All
          </Button>
        </div>
      </CardHeader>
      <CardContent>
        <Tabs defaultValue={DOCUMENT_TYPES[0].key} className="w-full">
          <TabsList className="grid w-full grid-cols-3 lg:grid-cols-6">
            {DOCUMENT_TYPES.map((docType) => {
              const doc = data.documents[docType.key];
              return (
                <TabsTrigger
                  key={docType.key}
                  value={docType.key}
                  disabled={!doc}
                  className="flex items-center gap-1"
                >
                  <span>{docType.icon}</span>
                  <span className="hidden sm:inline">{docType.label}</span>
                </TabsTrigger>
              );
            })}
          </TabsList>

          {DOCUMENT_TYPES.map((docType) => {
            const doc = data.documents[docType.key];
            if (!doc) return null;

            return (
              <TabsContent key={docType.key} value={docType.key} className="space-y-4">
                <div className="flex items-center justify-between">
                  <div>
                    <h3 className="text-lg font-semibold">{docType.label}</h3>
                    <p className="text-sm text-muted-foreground">{docType.description}</p>
                  </div>
                  <Button onClick={() => downloadDocument(doc)} variant="outline" size="sm">
                    <Download className="h-4 w-4 mr-2" />
                    Download
                  </Button>
                </div>

                <div className="prose dark:prose-invert max-w-none border rounded-lg p-6 bg-muted/30">
                  <ReactMarkdown>{doc.content}</ReactMarkdown>
                </div>

                <div className="flex items-center justify-between text-xs text-muted-foreground">
                  <span>Version {doc.version}</span>
                  <span>Created: {new Date(doc.createdAt).toLocaleString()}</span>
                </div>
              </TabsContent>
            );
          })}
        </Tabs>
      </CardContent>
    </Card>
  );
}
